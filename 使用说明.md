# ESP32墨水屏 - MQTT云端控制

通过云服务器和MQTT协议远程控制ESP32墨水屏显示图片。

## 🌐 系统架构

```
用户浏览器 <--> 云服务器 (Web + MQTT) <--> ESP32 (MQTT客户端) <--> 墨水屏
```

---

## ⚙️ ESP32配置

### 第一步：安装Arduino库

在Arduino IDE中安装：
- **PubSubClient** (by Nick O'Leary)
- **ArduinoJson** (by Benoit Blanchon) - 版本6.x

### 第二步：修改配置

打开 `Loader_esp32wf.ino`：

#### 1. WiFi配置（两种方式）

**方式1：首次配网（推荐）**
- 设备上电后会自动进入AP配网模式
- 连接WiFi热点：`EPD-XXXXXX`（设备码后6位，无密码）
- 访问 http://192.168.4.1
- 输入WiFi名称和密码，点击连接
- 设备会自动重启并连接WiFi

**方式2：硬编码配置（已弃用）**
如需硬编码，可在 `Loader_esp32wf.ino` 中修改（不推荐）：
```cpp
const char *ssid = "你的WiFi名称";
const char *password = "你的WiFi密码";
```

#### 2. 修改MQTT服务器（在mqtt_config.h第29行）
```cpp
#define MQTT_HOST "8.135.238.216"  // 改成你的云服务器IP
#define MQTT_PORT 1883
#define MQTT_USER "admin"
#define MQTT_PASS "admin"
```

### 第三步：上传代码

1. 连接ESP32到电脑
2. 选择开发板：**ESP32 Dev Module**
3. 选择正确的串口
4. 点击"上传"
5. 打开串口监视器（115200波特率）
6. **记录显示的设备ID**，例如：`C3-7CDFA1B2C3D4`

---

## ☁️ 云服务器部署

### 方式1：一键安装（推荐）

SSH连接到你的服务器：
```bash
ssh root@8.135.238.216
```

上传 `cloud_server` 文件夹，然后运行：
```bash
cd cloud_server
chmod +x install.sh
bash install.sh
```

安装脚本会自动：
- ✅ 安装MQTT Broker (Mosquitto)
- ✅ 安装Node.js和依赖
- ✅ 配置防火墙
- ✅ 启动服务

### 方式2：Docker部署

```bash
# 在项目根目录运行
docker-compose up -d
```

详细部署步骤请查看：**DEPLOYMENT.md** 或 **QUICKSTART.md**

---

## 🎨 使用方法

### 1. 访问Web界面
```
http://你的服务器IP:3000
```

### 2. 输入设备信息
- **设备ID**：输入ESP32显示的设备ID（例如：`C3-7CDFA1B2C3D4`）
- **墨水屏型号**：从下拉列表选择你的墨水屏型号

### 3. 上传图片
- 拖拽图片到虚线框，或点击"选择图片"按钮
- 调整参数（偏移、尺寸等）
- 点击"处理图片"查看预览
- 点击"上传到设备"发送到ESP32

### 4. 观察结果
- ESP32串口会显示接收到的命令
- 墨水屏会刷新显示图片（约10-30秒）

---

## 🌐 网络配置

### DHCP自动获取IP（默认）
默认情况下，ESP32会自动从路由器获取IP地址。

**优点**：
- ✅ 自动配置，无需手动设置
- ✅ 适合大多数使用场景
- ✅ 路由器自动管理IP分配

### 使用静态IP（可选）

如果需要固定IP地址，在 `Loader_esp32wf.ino` 第47-50行，取消注释：

```cpp
// 取消下面的注释以使用静态IP：
if (WiFi.config(staticIP, gateway, subnet, dns, dns) == false) {
    Serial.println("Static IP configuration failed.");
}
```

然后修改静态IP配置（第21-24行）：
```cpp
IPAddress staticIP(192, 168, 10, 166);  // 改成你想要的IP
IPAddress gateway(192, 168, 10, 1);     // 改成你的网关
IPAddress subnet(255, 255, 255, 0);
IPAddress dns(223, 5, 5, 5);
```

---

## 🔍 故障排查

### ESP32无法连接WiFi

**首次使用（未配网）**：
- 设备会自动进入AP配网模式
- 串口会显示：
```
📡 启动AP热点模式...
   AP名称: EPD-XXXXXX
   AP密码: 无密码
   AP IP地址: 192.168.4.1
```
- 连接热点并访问 http://192.168.4.1 进行配网

**已配网但连接失败**：
- ✅ 检查WiFi信号强度是否足够
- ✅ 路由器是否开启2.4GHz频段（ESP32不支持5GHz）
- ✅ 如果WiFi密码已更改，需要重新配网（清除配置后重启）

**重新配网方法**：
- 清除设备配置后重启，设备会重新进入AP配网模式

### ESP32无法连接MQTT

**串口显示**：`❌ 连接失败, rc=-2`

**解决方案**：
1. 检查 `mqtt_config.h` 中的服务器IP是否正确
2. 检查服务器防火墙是否开放1883端口：
   ```bash
   sudo ufw status
   sudo ufw allow 1883/tcp
   ```
3. 在服务器上测试MQTT是否运行：
   ```bash
   systemctl status mosquitto
   mosquitto_sub -h localhost -p 1883 -u admin -P admin -t '#'
   ```

### Web界面无法访问

**检查清单**：
```bash
# 1. 检查Node.js服务
pm2 status
pm2 logs esp32-cloud

# 2. 检查端口
netstat -tulpn | grep 3000

# 3. 检查防火墙
sudo ufw status
sudo ufw allow 3000/tcp
```

### 图片上传没反应

**解决步骤**：
1. ✅ 确认设备ID正确（查看ESP32串口输出）
2. ✅ 确认ESP32显示 `✅ MQTT已连接`
3. ✅ 打开浏览器开发者工具（F12）查看网络请求
4. ✅ 查看云端日志：`pm2 logs esp32-cloud`
5. ✅ 查看ESP32串口输出，看是否收到消息

---

## 📝 串口输出示例

### 正常启动
```
Connecting to XXGF
....
WiFi connected
IP address: 192.168.1.123

========================================
  MQTT云端控制模式
========================================
设备ID: C3-7CDFA1B2C3D4
MQTT服务器: 8.135.238.216:1883
========================================

正在连接MQTT...
✅ MQTT已连接
订阅主题: dev/C3-7CDFA1B2C3D4/down/#
✅ 系统就绪，等待云端命令...
```

### 接收图片命令
```
📥 MQTT消息: dev/C3-7CDFA1B2C3D4/down/epd
命令: EPD
📱 初始化EPD类型: 0
✅ EPD初始化完成

📥 MQTT消息: dev/C3-7CDFA1B2C3D4/down/epd
命令: LOAD
📥 接收数据: 1000 字节 (缓冲区: 1000/10000)
   执行加载...

...

📥 MQTT消息: dev/C3-7CDFA1B2C3D4/down/epd
命令: SHOW
🎨 刷新显示...
✅ 显示完成
```

---

## 🚀 高级功能

### 管理服务

```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs esp32-cloud

# 重启服务
pm2 restart esp32-cloud

# 停止服务
pm2 stop esp32-cloud

# 查看资源使用
pm2 monit
```

### MQTT调试

```bash
# 订阅所有主题
mosquitto_sub -h localhost -p 1883 -u admin -P admin -t '#' -v

# 订阅特定设备
mosquitto_sub -h localhost -p 1883 -u admin -P admin -t 'dev/C3-7CDFA1B2C3D4/#' -v

# 手动发送测试消息
mosquitto_pub -h localhost -p 1883 -u admin -P admin -t 'dev/C3-7CDFA1B2C3D4/down/epd' -m '{"cmd":"EPD","type":0}'
```

---

## 📚 更多文档

- **快速开始**: `QUICKSTART.md` - 5分钟上手指南
- **详细部署**: `DEPLOYMENT.md` - 完整部署步骤
- **完整文档**: `README.md` - 项目详细文档
- **项目结构**: `项目结构.txt` - 文件清单

---

## 🎯 MQTT主题说明

### 下行主题（云端 → ESP32）
```
dev/{deviceId}/down/epd        # EPD控制命令
```

**命令格式**：
```json
// 初始化EPD
{"cmd": "EPD", "type": 0, "timestamp": 1234567890}

// 加载数据
{"cmd": "LOAD", "data": [0,255,128,...], "length": 1000}

// 切换通道
{"cmd": "NEXT", "timestamp": 1234567890}

// 显示
{"cmd": "SHOW", "timestamp": 1234567890}
```

### 上行主题（ESP32 → 云端）
```
dev/{deviceId}/up/status       # 设备状态上报
```

**状态格式**：
```json
{
  "deviceId": "C3-7CDFA1B2C3D4",
  "rssi": -45,
  "ip": "192.168.1.100",
  "uptime_ms": 12345678,
  "freeHeap": 200000
}
```

---

## 🛠️ 文件配置位置

| 配置项 | 文件 | 行数 |
|--------|------|------|
| WiFi SSID/密码 | `Loader_esp32wf.ino` | 18-19 |
| 静态IP设置 | `Loader_esp32wf.ino` | 21-24 |
| MQTT服务器 | `mqtt_config.h` | 29-32 |

---

需要帮助？查看串口输出的错误信息，或参考完整的故障排查文档。
