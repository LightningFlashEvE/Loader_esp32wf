# è®¾å¤‡ç»‘å®šåŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®ç°äº†è®¾å¤‡ç»‘å®šçŠ¶æ€ç®¡ç†åŠŸèƒ½ï¼Œç¡®ä¿ï¼š
- **å·²ç»‘å®šè®¾å¤‡**ï¼šä¸Šç”µåä¸æ˜¾ç¤ºè®¾å¤‡ç ï¼Œä¼˜å…ˆæ˜¾ç¤ºäº‘ç«¯ä¸‹å‘çš„å›¾ç‰‡ç¼“å­˜
- **æœªç»‘å®šè®¾å¤‡**ï¼šä¸Šç”µåæ˜¾ç¤ºé…å¯¹ç /è®¾å¤‡ç ï¼Œå¯é€šè¿‡ç½‘é¡µç»‘å®š
- **ç¦»çº¿ç­–ç•¥**ï¼šå·²ç»‘å®šè®¾å¤‡ç¦»çº¿æ—¶ä¸æ˜¾ç¤ºè®¾å¤‡ç ï¼›æœªç»‘å®šè®¾å¤‡åœ¨åˆç†è¶…æ—¶åæ˜¾ç¤ºé…å¯¹ç 

---

## ğŸ”§ å›ºä»¶ä¾§æ”¹åŠ¨ï¼ˆESP32ï¼‰

### 1. æ–°å¢æ–‡ä»¶/æ¨¡å—
- **æ— æ–°å¢æ–‡ä»¶**ï¼Œæ‰€æœ‰æ”¹åŠ¨åœ¨ `mqtt_config.h` ä¸­

### 2. ä¸»è¦æ”¹åŠ¨ç‚¹

#### 2.1 æ·»åŠ ä¾èµ–åº“
```cpp
#include <Preferences.h>  // NVSæŒä¹…åŒ–å­˜å‚¨
#include <HTTPClient.h>   // HTTPå®¢æˆ·ç«¯
```

#### 2.2 æ–°å¢å…¨å±€å˜é‡
- `Preferences preferences` - NVSæŒä¹…åŒ–å­˜å‚¨å¯¹è±¡
- `bool deviceClaimed` - æœ¬åœ°ç»‘å®šçŠ¶æ€æ ‡å¿—
- `PREF_NAMESPACE` / `PREF_KEY_CLAIMED` - æŒä¹…åŒ–é”®å
- `CLOUD_API_HOST` / `CLOUD_API_PORT` - äº‘ç«¯APIé…ç½®

#### 2.3 æ–°å¢å‡½æ•°

**`loadClaimedStatus()`** - è¯»å–æœ¬åœ°æŒä¹…åŒ–çš„ç»‘å®šçŠ¶æ€
- ä»NVSè¯»å– `claimed` æ ‡å¿—
- è¿”å› `bool` å€¼

**`saveClaimedStatus(bool claimed)`** - ä¿å­˜æœ¬åœ°æŒä¹…åŒ–çš„ç»‘å®šçŠ¶æ€
- å†™å…¥NVSï¼Œæ‰ç”µä¸ä¸¢å¤±

**`queryDeviceStatus()`** - å‘äº‘ç«¯æŸ¥è¯¢è®¾å¤‡ç»‘å®šçŠ¶æ€
- å‘é€POSTè¯·æ±‚åˆ° `/api/device/status`
- è¿”å› `DeviceStatusResponse` ç»“æ„ä½“ï¼ŒåŒ…å«ï¼š
  - `claimed`: ç»‘å®šçŠ¶æ€
  - `pairingCode`: é…å¯¹ç ï¼ˆæœªç»‘å®šæ—¶ï¼‰
  - `expiresIn`: é…å¯¹ç æœ‰æ•ˆæœŸ
  - `imageUrl` / `imageVersion`: å›¾ç‰‡ä¿¡æ¯ï¼ˆå·²ç»‘å®šæ—¶ï¼‰

#### 2.4 ä¿®æ”¹å‡½æ•°

**`MQTT__setup()`** - å¯åŠ¨æ—¶åˆå§‹åŒ–
- è¯»å–æœ¬åœ° `claimed` çŠ¶æ€
- æ ¹æ®çŠ¶æ€å†³å®šåç»­æµç¨‹

**`MQTT__loop()`** - ä¸»å¾ªç¯é€»è¾‘
- å¯åŠ¨å2ç§’æŸ¥è¯¢äº‘ç«¯ç»‘å®šçŠ¶æ€
- æ ¹æ®æŸ¥è¯¢ç»“æœå†³å®šæ˜¯å¦æ˜¾ç¤ºè®¾å¤‡ç ï¼š
  - æœ¬åœ°å·²ç»‘å®š + äº‘ç«¯å·²ç»‘å®š â†’ ä¸æ˜¾ç¤ºè®¾å¤‡ç 
  - æœ¬åœ°å·²ç»‘å®š + äº‘ç«¯ä¸å¯è¾¾ â†’ ä¸æ˜¾ç¤ºè®¾å¤‡ç ï¼ˆç¦»çº¿ç­–ç•¥ï¼‰
  - æœ¬åœ°æœªç»‘å®š + äº‘ç«¯æœªç»‘å®š â†’ æ˜¾ç¤ºè®¾å¤‡ç 
  - æœ¬åœ°æœªç»‘å®š + äº‘ç«¯ä¸å¯è¾¾ â†’ è¶…æ—¶åæ˜¾ç¤ºè®¾å¤‡ç 
- å®šæœŸï¼ˆçº¦2.5åˆ†é’Ÿï¼‰æ£€æŸ¥ç»‘å®šçŠ¶æ€æ›´æ–°

**`mqttCallback()`** - MQTTæ¶ˆæ¯å›è°ƒ
- æ”¶åˆ°äº‘ç«¯å‘½ä»¤æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æœ¬åœ°ç»‘å®šçŠ¶æ€ä¸ºå·²ç»‘å®š

### 3. å¯åŠ¨æµç¨‹

```
ä¸Šç”µå¯åŠ¨
  â†“
è¿æ¥WiFi
  â†“
è¯»å–æœ¬åœ°claimedçŠ¶æ€
  â†“
è¿æ¥MQTT
  â†“
[2ç§’å] æŸ¥è¯¢äº‘ç«¯ç»‘å®šçŠ¶æ€
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°å·²ç»‘å®š      â”‚  æœ¬åœ°æœªç»‘å®š      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº‘ç«¯å·²ç»‘å®š âœ“     â”‚ äº‘ç«¯æœªç»‘å®š â†’ æ˜¾ç¤ºè®¾å¤‡ç 
â”‚ äº‘ç«¯ä¸å¯è¾¾ âœ“     â”‚ äº‘ç«¯ä¸å¯è¾¾ â†’ è¶…æ—¶åæ˜¾ç¤º
â”‚ äº‘ç«¯æœªç»‘å®š â†’ æ›´æ–°â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ç¼–è¯‘è¦æ±‚

ç¡®ä¿Arduinoåº“å·²å®‰è£…ï¼š
- **Preferences** (ESP32æ ¸å¿ƒåº“è‡ªå¸¦)
- **HTTPClient** (ESP32æ ¸å¿ƒåº“è‡ªå¸¦)
- **PubSubClient** (éœ€æ‰‹åŠ¨å®‰è£…)
- **ArduinoJson** v6.x (éœ€æ‰‹åŠ¨å®‰è£…)

---

## â˜ï¸ äº‘ç«¯æ”¹åŠ¨ï¼ˆFlask + MongoDBï¼‰

### 1. æ•°æ®åº“Schemaæ‰©å±•

#### 1.1 `devices` é›†åˆ
æ–°å¢å­—æ®µï¼š
- `claimed` (bool): è®¾å¤‡ç»‘å®šçŠ¶æ€ï¼Œé»˜è®¤ `false`
- å·²æœ‰å­—æ®µä¿æŒä¸å˜ï¼š`deviceId`, `owner`, `deviceName`, `addedAt` ç­‰

#### 1.2 `pairing_codes` é›†åˆï¼ˆæ–°å»ºï¼‰
æ–‡æ¡£ç»“æ„ï¼š
```javascript
{
  deviceId: "C37CDF",        // è®¾å¤‡IDï¼ˆå”¯ä¸€ï¼‰
  code: "123456",            // 6ä½æ•°å­—é…å¯¹ç 
  expiresAt: ISODate(...),   // è¿‡æœŸæ—¶é—´ï¼ˆTTLç´¢å¼•ï¼‰
  createdAt: ISODate(...)    // åˆ›å»ºæ—¶é—´
}
```

ç´¢å¼•ï¼š
- `deviceId`: å”¯ä¸€ç´¢å¼•
- `expiresAt`: TTLç´¢å¼•ï¼ˆè‡ªåŠ¨è¿‡æœŸæ¸…ç†ï¼Œ0ç§’ååˆ é™¤ï¼‰

### 2. æ–°å¢APIæ¥å£

#### 2.1 `POST /api/device/status` - è®¾å¤‡æŸ¥è¯¢ç»‘å®šçŠ¶æ€
**ç”¨é€”**ï¼šè®¾å¤‡ä¸Šç”µæ—¶è°ƒç”¨ï¼ŒæŸ¥è¯¢ç»‘å®šçŠ¶æ€

**è¯·æ±‚**ï¼š
```json
{
  "deviceId": "C37CDF"
}
```

**å“åº”ï¼ˆå·²ç»‘å®šï¼‰**ï¼š
```json
{
  "claimed": true,
  "imageVersion": 1
}
```

**å“åº”ï¼ˆæœªç»‘å®šï¼‰**ï¼š
```json
{
  "claimed": false,
  "pairingCode": "123456",
  "expiresIn": 86400
}
```

**ç‰¹ç‚¹**ï¼š
- æ— éœ€ç™»å½•ï¼ˆè®¾å¤‡è°ƒç”¨ï¼‰
- æœªç»‘å®šæ—¶è‡ªåŠ¨ç”Ÿæˆé…å¯¹ç 
- é…å¯¹ç æœ‰æ•ˆæœŸ24å°æ—¶

#### 2.2 `POST /api/device/claim` - ç”¨æˆ·ç»‘å®šè®¾å¤‡
**ç”¨é€”**ï¼šç½‘é¡µç”¨æˆ·ç»‘å®šè®¾å¤‡

**è¯·æ±‚**ï¼š
```json
{
  "deviceId": "C37CDF",
  "pairingCode": "123456",  // å¯é€‰
  "deviceName": "æˆ‘çš„è®¾å¤‡"  // å¯é€‰
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "Device claimed successfully",
  "deviceId": "C37CDF"
}
```

**ç‰¹ç‚¹**ï¼š
- éœ€è¦ç™»å½•ï¼ˆ`@login_required`ï¼‰
- æ”¯æŒé…å¯¹ç éªŒè¯ï¼ˆå¯é€‰ï¼‰
- è‡ªåŠ¨åˆ é™¤é…å¯¹ç 
- é˜²æ­¢é‡å¤ç»‘å®šï¼ˆåŒä¸€è®¾å¤‡åªèƒ½è¢«ä¸€ä¸ªç”¨æˆ·ç»‘å®šï¼‰

#### 2.3 `POST /api/device/unbind` - è§£ç»‘è®¾å¤‡
**ç”¨é€”**ï¼šç”¨æˆ·è§£ç»‘è®¾å¤‡ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

**è¯·æ±‚**ï¼š
```json
{
  "deviceId": "C37CDF"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "Device unbound successfully",
  "deviceId": "C37CDF"
}
```

**ç‰¹ç‚¹**ï¼š
- éœ€è¦ç™»å½•
- ä»…è®¾å¤‡æ‰€æœ‰è€…å¯è§£ç»‘
- è§£ç»‘åè®¾å¤‡å¯é‡æ–°ç»‘å®š

### 3. ä¿®æ”¹çš„APIæ¥å£

#### 3.1 `POST /api/devices/add` - æ·»åŠ è®¾å¤‡
**æ”¹åŠ¨**ï¼š
- æ·»åŠ è®¾å¤‡æ—¶è‡ªåŠ¨è®¾ç½® `claimed: true`
- è‡ªåŠ¨åˆ é™¤å¯èƒ½å­˜åœ¨çš„é…å¯¹ç 
- å¦‚æœè®¾å¤‡å·²å­˜åœ¨ï¼Œæ›´æ–°ä¸ºå·²ç»‘å®šçŠ¶æ€

### 4. æ•°æ®åº“ç´¢å¼•åˆ›å»º

è¿è¡Œç´¢å¼•åˆ›å»ºè„šæœ¬ï¼š
```bash
cd cloud_server/backend
python create_indexes.py
```

æˆ–æ‰‹åŠ¨åˆ›å»ºï¼š
```javascript
// MongoDB shell
use esp32_epd

// devicesé›†åˆç´¢å¼•
db.devices.createIndex({deviceId: 1}, {unique: true})
db.devices.createIndex({owner: 1})
db.devices.createIndex({claimed: 1})

// pairing_codesé›†åˆç´¢å¼•
db.pairing_codes.createIndex({deviceId: 1}, {unique: true})
db.pairing_codes.createIndex({expiresAt: 1}, {expireAfterSeconds: 0})
```

---

## ğŸ” å®‰å…¨å»ºè®®ï¼ˆå¯é€‰å‡çº§ï¼‰

### æœ€å°æ–¹æ¡ˆï¼ˆå½“å‰å®ç°ï¼‰
- è®¾å¤‡ `status` è¯·æ±‚åªå¸¦ `deviceId`
- ç»‘å®šæ¥å£éœ€è¦ç”¨æˆ·ç™»å½•éªŒè¯

### æ¨èæ–¹æ¡ˆï¼ˆå¯å‡çº§ï¼‰
ä¸ºæ¯å°è®¾å¤‡é¢„ç½® `device_secret`ï¼Œ`status` è¯·æ±‚å¸¦HMACç­¾åï¼š

**ä¼ªä»£ç ç¤ºä¾‹**ï¼š
```python
# äº‘ç«¯éªŒè¯
import hmac
import hashlib

def verify_device_request(device_id, timestamp, signature):
    device = devices_collection.find_one({'deviceId': device_id})
    if not device:
        return False
    
    secret = device.get('deviceSecret')
    expected = hmac.new(
        secret.encode(),
        f"{device_id}:{timestamp}".encode(),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(expected, signature)

# å›ºä»¶ä¾§ç­¾å
String sign = HMAC_SHA256(deviceSecret, deviceId + ":" + timestamp);
```

---

## ğŸ“ å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### ç»‘å®šè®¾å¤‡ï¼ˆä½¿ç”¨æ–°æ¥å£ï¼‰
```javascript
async function claimDevice(deviceId, pairingCode) {
    const response = await fetch('/api/device/claim', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
            deviceId: deviceId,
            pairingCode: pairingCode  // å¯é€‰
        })
    });
    
    const result = await response.json();
    if (result.success) {
        console.log('è®¾å¤‡ç»‘å®šæˆåŠŸ');
    }
}
```

### æŸ¥è¯¢è®¾å¤‡çŠ¶æ€ï¼ˆè®¾å¤‡ç«¯è°ƒç”¨ï¼‰
```javascript
// å›ºä»¶ä¾§å·²å®ç°ï¼Œæ— éœ€å‰ç«¯è°ƒç”¨
```

### è§£ç»‘è®¾å¤‡
```javascript
async function unbindDevice(deviceId) {
    const response = await fetch('/api/device/unbind', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
            deviceId: deviceId
        })
    });
    
    const result = await response.json();
    if (result.success) {
        console.log('è®¾å¤‡è§£ç»‘æˆåŠŸ');
    }
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†æ£€æŸ¥

### 1. è®¾å¤‡å·²ç»‘å®šæ—¶
- âœ… ä¸Šç”µåä¸ä¼šæ˜¾ç¤ºè®¾å¤‡ç 
- âœ… ä¸ä¼šè¦†ç›–äº‘ç«¯ä¸‹å‘å›¾ç‰‡
- âœ… ç¦»çº¿æ—¶ä¸æ˜¾ç¤ºè®¾å¤‡ç 

### 2. æœªç»‘å®šæ—¶
- âœ… ä¸Šç”µåæ˜¾ç¤ºé…å¯¹ç /è®¾å¤‡ç 
- âœ… å¯é€šè¿‡ç½‘é¡µç»‘å®š
- âœ… ç»‘å®šåä¸‹ä¸€æ¬¡çŠ¶æ€æ›´æ–°å³ä¸å†æ˜¾ç¤ºè®¾å¤‡ç 

### 3. å¼±ç½‘/ç¦»çº¿æ—¶
- âœ… å·²ç»‘å®šè®¾å¤‡ä¸æ˜¾ç¤ºè®¾å¤‡ç 
- âœ… æœªç»‘å®šè®¾å¤‡åœ¨åˆç†è¶…æ—¶åæ˜¾ç¤ºé…å¯¹ç 

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å›ºä»¶ä¾§
1. æ‰“å¼€ `Loader_esp32wf.ino` é¡¹ç›®
2. ç¡®è®¤å·²å®‰è£…æ‰€éœ€åº“ï¼ˆPreferences, HTTPClient, PubSubClient, ArduinoJsonï¼‰
3. ç¼–è¯‘å¹¶ä¸Šä¼ åˆ°ESP32
4. è§‚å¯Ÿä¸²å£è¾“å‡ºï¼Œç¡®è®¤ç»‘å®šçŠ¶æ€æŸ¥è¯¢æ­£å¸¸

### 2. äº‘ç«¯ä¾§
1. è¿è¡Œç´¢å¼•åˆ›å»ºè„šæœ¬ï¼š
   ```bash
   cd cloud_server/backend
   python create_indexes.py
   ```

2. é‡å¯FlaskæœåŠ¡ï¼š
   ```bash
   # å¦‚æœä½¿ç”¨systemd
   sudo systemctl restart esp32-cloud
   
   # å¦‚æœä½¿ç”¨pm2
   pm2 restart esp32-cloud
   
   # å¦‚æœç›´æ¥è¿è¡Œ
   python app.py
   ```

3. æµ‹è¯•APIæ¥å£ï¼š
   ```bash
   # æŸ¥è¯¢è®¾å¤‡çŠ¶æ€ï¼ˆæ— éœ€tokenï¼‰
   curl -X POST http://localhost:5000/api/device/status \
     -H "Content-Type: application/json" \
     -d '{"deviceId":"C37CDF"}'
   
   # ç»‘å®šè®¾å¤‡ï¼ˆéœ€è¦tokenï¼‰
   curl -X POST http://localhost:5000/api/device/claim \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{"deviceId":"C37CDF","pairingCode":"123456"}'
   ```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### å›ºä»¶ä¾§
- `mqtt_config.h` - ä¸»è¦æ”¹åŠ¨æ–‡ä»¶

### äº‘ç«¯ä¾§
- `cloud_server/backend/app.py` - Flask APIå®ç°
- `cloud_server/backend/create_indexes.py` - ç´¢å¼•åˆ›å»ºè„šæœ¬ï¼ˆæ–°å»ºï¼‰
- `cloud_server/backend/config.py` - é…ç½®æ–‡ä»¶ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰

### æ–‡æ¡£
- `ç»‘å®šåŠŸèƒ½å®ç°è¯´æ˜.md` - æœ¬æ–‡æ¡£ï¼ˆæ–°å»ºï¼‰

---

## ğŸ”„ Node.js ç­‰ä»·å®ç°å»ºè®®

å¦‚æœéœ€è¦åœ¨Node.jsåç«¯å®ç°ç›¸åŒåŠŸèƒ½ï¼Œå‚è€ƒä»¥ä¸‹ä»£ç ï¼š

### 1. è®¾å¤‡çŠ¶æ€æŸ¥è¯¢æ¥å£

```javascript
// Express.js ç¤ºä¾‹
app.post('/api/device/status', async (req, res) => {
    try {
        const { deviceId } = req.body;
        
        // æŸ¥è¯¢è®¾å¤‡ç»‘å®šçŠ¶æ€
        const device = await db.collection('devices').findOne({ deviceId });
        const claimed = device && device.claimed === true;
        
        const response = { claimed };
        
        // å¦‚æœæœªç»‘å®šï¼Œç”Ÿæˆé…å¯¹ç 
        if (!claimed) {
            let pairingDoc = await db.collection('pairing_codes').findOne({ deviceId });
            
            if (!pairingDoc || pairingDoc.expiresAt < new Date()) {
                // ç”Ÿæˆæ–°é…å¯¹ç 
                const pairingCode = Math.floor(100000 + Math.random() * 900000).toString();
                const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24å°æ—¶
                
                await db.collection('pairing_codes').updateOne(
                    { deviceId },
                    {
                        $set: {
                            code: pairingCode,
                            expiresAt: expiresAt,
                            createdAt: new Date()
                        }
                    },
                    { upsert: true }
                );
                
                pairingDoc = { code: pairingCode, expiresAt };
            }
            
            const expiresIn = Math.floor((pairingDoc.expiresAt - new Date()) / 1000);
            response.pairingCode = pairingDoc.code;
            response.expiresIn = expiresIn;
        }
        
        res.json(response);
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});
```

### 2. è®¾å¤‡ç»‘å®šæ¥å£

```javascript
app.post('/api/device/claim', requireAuth, async (req, res) => {
    try {
        const { deviceId, pairingCode } = req.body;
        const owner = req.user.username;
        
        // éªŒè¯é…å¯¹ç ï¼ˆå¦‚æœæä¾›ï¼‰
        if (pairingCode) {
            const pairingDoc = await db.collection('pairing_codes').findOne({ deviceId });
            if (!pairingDoc || pairingDoc.code !== pairingCode) {
                return res.status(400).json({ success: false, error: 'Invalid pairing code' });
            }
            if (pairingDoc.expiresAt < new Date()) {
                return res.status(400).json({ success: false, error: 'Pairing code expired' });
            }
        }
        
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è¢«ç»‘å®š
        const existing = await db.collection('devices').findOne({ deviceId });
        if (existing && existing.claimed && existing.owner !== owner) {
            return res.status(403).json({ success: false, error: 'Device already claimed' });
        }
        
        // æ›´æ–°æˆ–åˆ›å»ºè®¾å¤‡è®°å½•
        await db.collection('devices').updateOne(
            { deviceId },
            {
                $set: {
                    owner: owner,
                    claimed: true,
                    updatedAt: new Date()
                },
                $setOnInsert: {
                    deviceName: req.body.deviceName || deviceId,
                    addedAt: new Date(),
                    createdAt: new Date()
                }
            },
            { upsert: true }
        );
        
        // åˆ é™¤é…å¯¹ç 
        await db.collection('pairing_codes').deleteOne({ deviceId });
        
        res.json({ success: true, message: 'Device claimed successfully', deviceId });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});
```

### 3. MongoDBç´¢å¼•åˆ›å»ºï¼ˆNode.jsï¼‰

```javascript
// ä½¿ç”¨mongodbé©±åŠ¨
const { MongoClient } = require('mongodb');

async function createIndexes() {
    const client = await MongoClient.connect(MONGODB_URI);
    const db = client.db(MONGODB_DB);
    
    // devicesé›†åˆç´¢å¼•
    await db.collection('devices').createIndex({ deviceId: 1 }, { unique: true });
    await db.collection('devices').createIndex({ owner: 1 });
    await db.collection('devices').createIndex({ claimed: 1 });
    
    // pairing_codesé›†åˆç´¢å¼•
    await db.collection('pairing_codes').createIndex({ deviceId: 1 }, { unique: true });
    await db.collection('pairing_codes').createIndex(
        { expiresAt: 1 },
        { expireAfterSeconds: 0 }  // TTLç´¢å¼•
    );
    
    await client.close();
}
```

### 4. ä¸»è¦å·®å¼‚ç‚¹

| åŠŸèƒ½ | Flask (Python) | Node.js |
|------|----------------|---------|
| HTTPæ¡†æ¶ | Flask | Express.js / Koa |
| MongoDBé©±åŠ¨ | pymongo | mongodb / mongoose |
| è®¤è¯ä¸­é—´ä»¶ | `@login_required` | `requireAuth` ä¸­é—´ä»¶ |
| æ—¥æœŸå¤„ç† | `datetime.utcnow()` | `new Date()` |
| TTLç´¢å¼• | `expireAfterSeconds=0` | `expireAfterSeconds: 0` |

**æ³¨æ„**ï¼šNode.jså®ç°é€»è¾‘ä¸Flaskå®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯è¯­æ³•ä¸åŒã€‚

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè®¾å¤‡ä¸€ç›´æ˜¾ç¤ºè®¾å¤‡ç 
**å¯èƒ½åŸå› **ï¼š
- æœ¬åœ° `claimed` çŠ¶æ€æœªæ­£ç¡®ä¿å­˜
- äº‘ç«¯æŸ¥è¯¢å¤±è´¥
- äº‘ç«¯æœªæ­£ç¡®è®¾ç½® `claimed` å­—æ®µ

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ä¸²å£è¾“å‡ºï¼ŒæŸ¥çœ‹ç»‘å®šçŠ¶æ€æŸ¥è¯¢ç»“æœ
2. æ£€æŸ¥MongoDBä¸­è®¾å¤‡çš„ `claimed` å­—æ®µ
3. æ‰‹åŠ¨è°ƒç”¨ `/api/device/claim` æ¥å£ç»‘å®šè®¾å¤‡

### é—®é¢˜2ï¼šäº‘ç«¯æŸ¥è¯¢è¿”å›é”™è¯¯
**å¯èƒ½åŸå› **ï¼š
- FlaskæœåŠ¡æœªè¿è¡Œ
- ç«¯å£é…ç½®é”™è¯¯
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥FlaskæœåŠ¡çŠ¶æ€
2. ç¡®è®¤ `CLOUD_API_HOST` å’Œ `CLOUD_API_PORT` é…ç½®æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜3ï¼šé…å¯¹ç ä¸ç”Ÿæˆ
**å¯èƒ½åŸå› **ï¼š
- MongoDBç´¢å¼•æœªåˆ›å»º
- `pairing_codes` é›†åˆä¸å­˜åœ¨

**è§£å†³æ–¹æ³•**ï¼š
1. è¿è¡Œ `create_indexes.py` è„šæœ¬
2. æ£€æŸ¥MongoDBè¿æ¥å’Œæƒé™

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ä¸²å£è¾“å‡ºæ—¥å¿—
2. FlaskæœåŠ¡æ—¥å¿—
3. MongoDBæ•°æ®åº“çŠ¶æ€
4. ç½‘ç»œè¿æ¥æƒ…å†µ
